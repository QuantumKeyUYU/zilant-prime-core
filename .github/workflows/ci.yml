# .github/workflows/ci.yml

name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint_and_test:
    runs-on: ubuntu-latest
    strategy:
      # Запускаем тесты на нескольких версиях Python, чтобы убедиться в совместимости
      matrix:
        python-version: ['3.11', '3.12', '3.13']

    steps:
      # 1. Получаем код из репозитория
      - uses: actions/checkout@v4

      # 2. Настраиваем нужную версию Python
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      # 3. Устанавливаем системные зависимости (например, для pynacl)
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libsodium-dev

      # 4. Устанавливаем все зависимости Python для разработки
      #    Это главное изменение!
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          # Эта строка важна, чтобы pynacl скомпилировался с системной libsodium
          pip install --no-cache-dir --no-binary :all: "pynacl>=1.5"
          # Устанавливаем все зависимости для разработки [dev] из pyproject.toml
          # Это включает pytest, pre-commit, black, ruff и все остальные инструменты.
          pip install .[dev]

      # 5. Запускаем pre-commit для проверки форматирования и линтинга
      #    Теперь эта команда будет работать, т.к. pre-commit установлен на шаге выше.
      - name: Pre-commit checks
        run: pre-commit run --all-files

      # 6. Запускаем тесты с покрытием кода
      - name: Run pytest
        run: pytest --cov=src --cov-report=xml
