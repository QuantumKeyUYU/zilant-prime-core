---
name: CI (Paranoid Stage 0)

on:  # yamllint disable-line truthy
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main

env:
  PYTHON_VERSION: '3.13'

jobs:
  # â”€â”€â”€ Ğ¨ĞĞ“ 1: Lint â†’ Type â†’ Test â†’ Coverage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint_and_test:
    name: Lint & Test & Coverage
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸš§ Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ğŸ“¦ Install dev dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel

          if [ -f requirements-dev.txt ]; then
            python -m pip install -r requirements-dev.txt
          fi

          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ»Ğ¸Ğ½Ñ‚Ğ¸Ğ½Ğ³Ğ° Ğ¸ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
          python -m pip install \
            pre-commit \
            ruff \
            black \
            isort \
            mypy \
            pytest \
            coverage

      - name: ğŸ” Run pre-commit hooks
        run: pre-commit run --all-files

      - name: ğŸ” Run ruff (lint)
        run: ruff check .

      - name: ğŸ” Run black (format check)
        run: black --check .

      - name: ğŸ” Run isort (import order)
        run: isort --check-only .

      - name: ğŸ” Run mypy (type check)
        run: mypy src

      - name: ğŸ§ª Run pytest with coverage
        run: |
          pytest --maxfail=1 --disable-warnings -q --cov=src
          coverage xml -o coverage.xml
          coverage html -d htmlcov

      - name: ğŸ“ Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage.xml
            htmlcov/

  # â”€â”€â”€ Ğ¨ĞĞ“ 2: Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ SBOM â†’ Grype/Trivy scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sbom_scan:
    name: SBOM â†’ Grype / Trivy
    needs: lint_and_test
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install SBOM tools
        run: |
          python -m pip install --upgrade pip

          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ syft Ñ‡ĞµÑ€ĞµĞ· PyPI
          python -m pip install syft

          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Trivy Ñ‡ĞµÑ€ĞµĞ· Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞºÑ€Ğ¸Ğ¿Ñ‚
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: ğŸ”§ Install Grype (CLI)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: âš™ï¸ Generate SBOM (CycloneDX JSON)
        run: syft . -o cyclonedx-json=sbom.json

      - name: ğŸ” Scan SBOM with Grype
        run: grype sbom:sbom.json --fail-on medium

      - name: ğŸ” Scan filesystem with Trivy
        run: |
          trivy sbom --format cyclonedx --output sbom-cdx.json .
          trivy fs --severity HIGH,CRITICAL --exit-code 1 .

      - name: ğŸ· Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-json
          path: sbom.json

  # â”€â”€â”€ Ğ¨ĞĞ“ 3: Semgrep Static Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  semgrep_scan:
    name: Semgrep Static Analysis
    needs: sbom_scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install Semgrep
        run: python -m pip install semgrep

      - name: ğŸ” Run Semgrep (OSS rules)
        uses: returntocorp/semgrep-action@v2
        with:
          config: 'p/ci'

  # â”€â”€â”€ Ğ¨ĞĞ“ 4: CodeQL Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  codeql_analysis:
    name: CodeQL Analysis
    needs: semgrep_scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: ğŸ›  Autobuild (Ğ½ĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ Python)
        uses: github/codeql-action/autobuild@v3

      - name: ğŸ” Run CodeQL queries
        uses: github/codeql-action/analyze@v3

  # â”€â”€â”€ Ğ¨ĞĞ“ 5: Sign & Release (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ Ñ‚ĞµĞ³Ğµ v*) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sign_and_release:
    name: Sign Artifacts & Publish Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: codeql_analysis
    runs-on: ubuntu-latest
    env:
      COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
      VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
      VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
    steps:
      - name: ğŸ› Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ”§ Install Cosign (CLI)
        run: |
          COSIGN_VERSION=v2.1.0
          curl -sSL https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-${COSIGN_VERSION}-linux-amd64 -o /usr/local/bin/cosign
          chmod +x /usr/local/bin/cosign

      - name: ğŸ“¦ Build Python packages
        run: |
          python -m pip install --upgrade pip setuptools wheel build
          python -m pip install build
          python -m build

      - name: ğŸ“ Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ñ€ĞµĞ»Ğ¸Ğ· Ğ¿Ğ¾ Ñ‚ĞµĞ³Ñƒ ${{ github.ref_name }}.
            â€“ âœ… Ğ’ÑĞµ Ğ»Ğ¸Ğ½Ñ‚Ñ‹, Ñ‚Ğ¸Ğ¿Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ, Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹
            â€“ âœ… SBOM + Grype/Trivy: Ğ½ĞµÑ‚ Ñ€Ğ¸ÑĞºĞ¾Ğ² â‰¥ medium
            â€“ âœ… Semgrep, CodeQL
            â€“ ğŸ“‘ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑŒ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ğ² Ñ‡ĞµÑ€ĞµĞ· Cosign

      - name: ğŸ” Sign artifacts with Cosign
        run: cosign sign --key cosign.key dist/*.tar.gz dist/*.whl

      - name: ğŸ· Upload signed artifacts to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            dist/*.tar.gz
            dist/*.whl
            cosign.pub

      - name: â¡ï¸ Update badges in README.md
        run: |
          echo "âœ… Ğ ĞµĞ»Ğ¸Ğ· Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸ Ğ±ĞµĞ¹Ğ´Ğ¶Ğ¸ Ğ² README."
