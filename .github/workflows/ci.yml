---
name: CI (Paranoid Stage 0)

on:  # yamllint disable-line truthy
  push:
    branches: [main]
    tags: ['v*.*.*']
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.13'

jobs:
  # â”€â”€â”€ Ğ¨ĞĞ“Â 1: Lint â†’ Type â†’ Test â†’ Coverage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint_and_test:
    name: Lint & Test & Coverage
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸš§ Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ğŸ“¦ Install devâ€‘dependencies (+Â black/isortÂ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾)
        run: |
          python -m pip install --upgrade pip setuptools wheel
          if [ -f requirements-dev.txt ]; then
            python -m pip install -r requirements-dev.txt
          fi
          # Ğ’ÑĞµĞ³Ğ´Ğ° ÑÑ‚Ğ°Ğ²Ğ¸Ğ¼ black/isort/ruff â€” Ğ²Ğ´Ñ€ÑƒĞ³ Ğ¸Ñ… Ğ½ĞµÑ‚ Ğ² requirements
          python -m pip install black isort ruff

      - name: ğŸ” Run preâ€‘commit hooks
        run: pre-commit run --all-files

      - name: ğŸ” Ruff (lint)
        run: ruff check .

      - name: ğŸ” Black (formatÂ check)
        run: python -m black --check .

      - name: ğŸ” isort (importÂ order)
        run: python -m isort --check-only .

      - name: ğŸ” mypy (typeÂ check)
        run: mypy src

      - name: ğŸ§ª PytestÂ +Â coverage
        run: |
          pytest --maxfail=1 --disable-warnings -q --cov=src
          coverage xml -o coverage.xml
          coverage html -d htmlcov

      - name: ğŸ“ Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage.xml
            htmlcov/

  # â”€â”€â”€ Ğ¨ĞĞ“Â 2: SBOMÂ â†’Â Grype /â€¯Trivy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sbom_scan:
    name: SBOM â†’ Grype / Trivy
    needs: lint_and_test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with: { python-version: ${{ env.PYTHON_VERSION }} }

      - name: ğŸ“¦ Install SyftÂ /â€¯TrivyÂ /â€¯Grype (Ğ¾Ñ„Ğ¸Ñ†.Â ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ñ‹)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
            | sh -s -- -b /usr/local/bin
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sh -s -- -b /usr/local/bin
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh \
            | sh -s -- -b /usr/local/bin

      - name: âš™ï¸ Generate SBOM (CycloneDXÂ JSON, Ğ¸ÑĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ .github)
        run: syft . -o cyclonedx-json=sbom.json -x .github

      - name: ğŸ” Grype scan (failâ€‘onÂ medium)
        run: grype sbom:sbom.json --fail-on medium

      - name: ğŸ” Trivy scan
        run: |
          trivy sbom --format cyclonedx --output sbom-cdx.json .
          trivy fs --severity HIGH,CRITICAL --exit-code 1 .

      - name: ğŸ· Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-json
          path: sbom.json

  # â”€â”€â”€ Ğ¨ĞĞ“Â 3: Semgrep Static Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  semgrep_scan:
    name: Semgrep Static Analysis
    needs: sbom_scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: python -m pip install semgrep
      - uses: returntocorp/semgrep-action@v2
        with: { config: "p/ci" }

  # â”€â”€â”€ Ğ¨ĞĞ“Â 4: CodeQL Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  codeql_analysis:
    name: CodeQL Analysis
    needs: semgrep_scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with: { languages: python }
      - uses: github/codeql-action/autobuild@v3
      - uses: github/codeql-action/analyze@v3

  # â”€â”€â”€ Ğ¨ĞĞ“Â 5: SignÂ &Â Release (Ğ¿Ğ¾Â Ñ‚ĞµĞ³ÑƒÂ v*) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sign_and_release:
    name: Sign Artifacts & Publish Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: codeql_analysis
    runs-on: ubuntu-latest
    env:
      COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
      VAULT_ADDR:      ${{ secrets.VAULT_ADDR }}
      VAULT_TOKEN:     ${{ secrets.VAULT_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with: { python-version: ${{ env.PYTHON_VERSION }} }

      - run: |
          python -m pip install --upgrade pip setuptools wheel build cosign

      - name: (Optional) Fetch Cosign key from Vault
        if: ${{ env.VAULT_ADDR && env.VAULT_TOKEN }}
        uses: hashicorp/vault-action@v2
        id: vault
        with:
          url:    ${{ env.VAULT_ADDR }}
          method: token
          token:  ${{ env.VAULT_TOKEN }}
          path:   secret/data/cosign

      - name: Write Cosign Private Key
        if: steps.vault.outputs['secret/data/cosign']
        run: |
          echo "${{ steps.vault.outputs['secret/data/cosign'] }}" | base64 -d > cosign.key
          chmod 600 cosign.key

      - run: python -m build

      - id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            âœ… Ğ›Ğ¸Ğ½Ñ‚Ñ‹/Ñ‚Ğ¸Ğ¿Ñ‹/Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹  
            âœ… SBOMÂ +Â Grype/TrivyÂ â€” Â«mediumâ€‘freeÂ»  
            âœ… SemgrepÂ +Â CodeQL  
            ğŸ“‘ ĞÑ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹Â Cosign

      - run: cosign sign --key cosign.key dist/*.tar.gz dist/*.whl

      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            dist/*.tar.gz
            dist/*.whl
            cosign.pub

      - run: echo "âœ… Ğ ĞµĞ»Ğ¸Ğ· Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½ â€” Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸ Ğ±ĞµĞ¹Ğ´Ğ¶Ğ¸ README Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸."
