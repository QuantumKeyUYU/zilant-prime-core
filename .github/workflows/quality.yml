# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: 2025 Zilant Prime Core contributors

name: Quality / CI pipeline

on:
  push:
    branches: [ main, ci-check-ready ]
  pull_request:
    branches: [ main, ci-check-ready ]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with: { python-version: "3.13" }
      - name: Install libsodium-dev
        run: sudo apt-get update && sudo apt-get install -y libsodium-dev
      - name: Install dev-deps
        run: |
          pip install -e .[dev]
          pip install --no-cache-dir --force-reinstall --no-binary :all: pynacl
      - name: Pre-commit
        run: pre-commit run --all-files
      - name: Pytest
        run: ZILANT_ALLOW_ROOT=1 pytest -q

  perf:
    needs: quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.13" }
      - name: Install libsodium-dev
        run: sudo apt-get update && sudo apt-get install -y libsodium-dev
      - name: Install dev-deps
        run: |
          pip install -e .[dev]
          pip install --no-cache-dir --force-reinstall --no-binary :all: pynacl
      - run: SKIP_FUZZ=1 ZILANT_ALLOW_ROOT=1 pytest -q -m perf --disable-warnings --maxfail=1

  large-file-test:
    needs: quality
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.13" }
      - name: Install libsodium-dev
        run: sudo apt-get update && sudo apt-get install -y libsodium-dev
      - name: Install dev-deps
        run: |
          pip install -e .[dev]
          pip install --no-cache-dir --force-reinstall --no-binary :all: pynacl
      - run: pytest -q tests/test_stream_large.py tests/test_stream_resume.py

  cli-polish:
    needs: quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.13" }
      - name: Install libsodium-dev
        run: sudo apt-get update && sudo apt-get install -y libsodium-dev
      - name: Install dev-deps
        run: |
          pip install -e .[dev]
          pip install --no-cache-dir --force-reinstall --no-binary :all: pynacl
      - run: pytest -q tests/test_cli_observability.py

  build-pq:
    needs: [ quality, perf ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { submodules: recursive, fetch-depth: 0 }
      - uses: actions/setup-python@v5
        with: { python-version: "3.13" }
      - name: Install libsodium-dev
        run: sudo apt-get update && sudo apt-get install -y libsodium-dev
      - name: Install build deps
        run: |
          pip install -e .[dev] build pyyaml
          pip install --no-cache-dir --force-reinstall --no-binary :all: pynacl
      - name: Build PQ wheels
        run: python tools/build_pq_wheels.py
      - uses: actions/upload-artifact@v4
        with:
          name: pq-wheels
          path: dist/*.whl
          if-no-files-found: ignore
