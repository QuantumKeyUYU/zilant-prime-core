name: Sign & Publish Artifacts

on:
  workflow_run:
    workflows: ["Quality"]
    types: [completed]

jobs:
  sbom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - run: pip install syft cyclonedx-cli cosign
      - run: syft . -o cyclonedx-json=sbom.json
      - uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json
  sign:
    needs: sbom
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: actions/download-artifact@v4
        with:
          name: sbom
      - run: cosign attach sbom --sbom sbom.json dist/*.whl
      - run: cosign sign --key ${{ secrets.COSIGN_KEY }} dist/*.whl
    env:
      COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
