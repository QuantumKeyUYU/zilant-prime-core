# SPDX-FileCopyrightText: 2025 Zilant Prime Core contributors
# SPDX-License-Identifier: MIT
name: Rotate Vault App Token

on:
  schedule:
    - cron: "0 */8 * * *"   # ÐšÐ°Ð¶Ð´Ñ‹Ðµ 8 Ñ‡Ð°ÑÐ¾Ð²
  workflow_dispatch:

permissions:
  contents: read
  secrets: write

jobs:
  rotate-token:
    name: Rotate Vault App Token
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure Vault credentials are available
        run: |
          if [ -z "${VAULT_ADDR}" ] || [ -z "${VAULT_TOKEN}" ]; then
            echo "âŒ VAULT_ADDR Ð¸Ð»Ð¸ VAULT_TOKEN Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ€Ð¾Ñ‚Ð°Ñ†Ð¸ÑŽ."
            exit 0
          fi

      - name: Request new Vault token
        id: request_token
        run: |
          set -e
          echo "ðŸ” Ð Ð¾Ñ‚Ð°Ñ†Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð° Ð² Vault..."
          NEW_TOKEN=$(curl --silent \
            --header "X-Vault-Token: ${{ secrets.VAULT_TOKEN }}" \
            --request POST \
            --data '{"policies":["app-policy"],"ttl":"8h"}' \
            ${{ secrets.VAULT_ADDR }}/v1/auth/token/create \
            | jq -r .auth.client_token)
          if [ -z "$NEW_TOKEN" ] || [ "$NEW_TOKEN" == "null" ]; then
            echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½."
            exit 1
          fi
          echo "ÐÐ¾Ð²Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½."
          echo "::set-output name=new_token::$NEW_TOKEN"

      - name: Fetch GitHub public key for encrypting secret
        id: getkey
        uses: actions/github-script@v7
        with:
          script: |
            const publicKey = await github.actions.getPublicKeyForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            return publicKey.data;

      - name: Encrypt new token
        id: encrypt
        run: |
          echo "${{ steps.getkey.output.key }}" | base64 --decode > public.key
          NEW_TOKEN="${{ steps.request_token.outputs.new_token }}"
          ENCRYPTED=$(openssl rsautl -encrypt -pubin -inkey public.key -oaep -in <(echo -n "$NEW_TOKEN") | base64)
          echo "::set-output name=encrypted_value::$ENCRYPTED"
          echo "::set-output name=key_id::$(jq -r .key_id <<< '${{ steps.getkey.output }}')"

      - name: Update GitHub Secret VAULT_APP_TOKEN
        uses: actions/github-script@v7
        with:
          script: |
            const keyId = `${{ steps.encrypt.outputs.key_id }}`;
            const encryptedValue = `${{ steps.encrypt.outputs.encrypted_value }}`;
            await github.actions.createOrUpdateRepoSecret({
              owner: context.repo.owner,
              repo: context.repo.repo,
              secret_name: 'VAULT_APP_TOKEN',
              encrypted_value: encryptedValue,
              key_id: keyId
            });

      - name: Revoke old Vault token (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
        if: ${{ always() }}
        run: |
          # Ð•ÑÐ»Ð¸ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ â€” Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ñ‚Ð¾Ð·Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½ Ð·Ð´ÐµÑÑŒ.
          # ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: curl --header "X-Vault-Token: ${{ secrets.VAULT_TOKEN }}" --request POST ${{ secrets.VAULT_ADDR }}/v1/auth/token/revoke-self
          echo "Ð¡Ñ‚Ð°Ñ€Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð° Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ñ‚Ð¾Ð·Ð²Ð°Ð½Ð° Ð¿Ð¾ Ð¼ÐµÑ€Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸."
