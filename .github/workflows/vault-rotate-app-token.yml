# SPDX-FileCopyrightText: 2025 Zilant Prime Core contributors
# SPDX-License-Identifier: MIT
name: Rotate Vault App Token

# Ð¦Ð¸ÐºÐ»Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº: ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ (0 Ñ‡Ð°ÑÐ¾Ð²)
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

# Ð”Ð»Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ‡ÐµÑ€ÐµÐ· GitHub Actions Ð²Ð°Ð¼ Ð½ÑƒÐ¶Ð½Ð¾ Ð² Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐµ
# Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð´Ð°Ñ‚ÑŒ GITHUB_TOKEN Ð¿Ñ€Ð°Ð²Ð¾ "secrets: write" (Settings â†’ Actions â†’ General â†’ Workflow permissions).
# ÐÐ¾ Ð² ÑÑ‚Ð¾Ð¼ YAML Ð¼Ñ‹ Ð½Ðµ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ `permissions: secrets: write`, Ñ‡Ñ‚Ð¾Ð±Ñ‹ 'act' Ð½Ðµ Ð¿Ð°Ð´Ð°Ð» Ð½Ð° Ð½ÐµÐ¸Ð·Ð²
permissions:
  contents: read
  id-token: write
  # ÐŸÐ ÐÐ’Ð Ð¡Ð•ÐšÐ Ð•Ð¢ÐžÐ’ Ð”Ð›Ð¯ GITHUB: Ð¿Ð¸ÑˆÐµÐ¼ Ð¸Ñ… ÑÐ²Ð½Ð¾ Ð² Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ñ… Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ,
  # Ð° Ð½Ðµ Ð² YAML. Ð­Ñ‚Ð¾ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ñ 'act'.

jobs:
  rotate-token:
    name: Rotate Vault App Token
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Vault credentials (skip if Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚)
        run: |
          if [ -z "${VAULT_ADDR:-}" ] || [ -z "${VAULT_TOKEN:-}" ]; then
            echo "âš ï¸ VAULT_ADDR Ð¸Ð»Ð¸ VAULT_TOKEN Ð½Ðµ Ð·Ð°Ð´Ð°Ð½Ñ‹ â€” Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ€Ð¾Ñ‚Ð°Ñ†Ð¸ÑŽ."
            exit 0
          fi

      - name: Request new Vault token
        id: request_token
        run: |
          set -e
          echo "ðŸ” Ð Ð¾Ñ‚Ð°Ñ†Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð° Ð² Vault..."
          NEW_TOKEN=$(
            curl --silent \
              --header "X-Vault-Token: ${{ secrets.VAULT_TOKEN }}" \
              --request POST \
              --data '{"policies":["app-policy"],"ttl":"24h"}' \
              ${{ secrets.VAULT_ADDR }}/v1/auth/token/create \
              | jq -r .auth.client_token
          )
          if [ -z "$NEW_TOKEN" ] || [ "$NEW_TOKEN" == "null" ]; then
            echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½."
            exit 1
          fi
          echo "âœ… ÐÐ¾Ð²Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½."
          echo "::set-output name=new_token::$NEW_TOKEN"

      - name: Fetch GitHub public key (Ð´Ð»Ñ ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑÐµÐºÑ€ÐµÑ‚Ð°)
        id: get_pubkey
        uses: actions/github-script@v7
        with:
          script: |
            const { data: publicKeyData } = await github.actions.getPublicKeyForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            return publicKeyData;

      - name: Encrypt new token with GitHub public key
        id: encrypt
        run: |
          echo "${{ steps.get_pubkey.outputs.key }}" | base64 --decode > public.key
          PLAINTEXT="${{ steps.request_token.outputs.new_token }}"
          CIPHERTEXT=$(echo -n "$PLAINTEXT" | \
            openssl rsautl -encrypt -pubin -inkey public.key -oaep | base64)
          echo "::set-output name=encrypted_value::$CIPHERTEXT"
          echo "::set-output name=key_id::$(jq -r .key_id <<< '${{ steps.get_pubkey.outputs }}')"

      - name: Update GitHub Secret VAULT_APP_TOKEN
        uses: actions/github-script@v7
        with:
          script: |
            const keyId = '${{ steps.encrypt.outputs.key_id }}';
            const encryptedValue = '${{ steps.encrypt.outputs.encrypted_value }}';
            await github.actions.createOrUpdateRepoSecret({
              owner: context.repo.owner,
              repo: context.repo.repo,
              secret_name: 'VAULT_APP_TOKEN',
              encrypted_value: encryptedValue,
              key_id: keyId
            });
            console.log("âœ… GitHub Secret VAULT_APP_TOKEN Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½.");

      - name: (ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾) Revoke old Vault token
        if: always()
        run: |
          echo "â„¹ï¸ Ð•ÑÐ»Ð¸ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ, Ð·Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶Ð½Ð¾"
          echo "::add-mask::${{ secrets.VAULT_TOKEN }}"
          echo "  curl --header \"X-Vault-Token: [REDACTED]\" \\"
          echo "       --request POST ${{ secrets.VAULT_ADDR }}/v1/auth/token/revoke-self"
          # Ð—Ð°ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾, Ñ‚.Ðº. Ñ€ÐµÐ²Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½ Ð¼Ð¾Ð¶Ð½Ð¾ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¸Ð»Ð¸ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¼ ÑˆÐ°Ð³Ð¾Ð¼.
